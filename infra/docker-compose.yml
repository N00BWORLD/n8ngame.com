version: '3.8'

services:
  # =========================================
  # 1. UM890 Core Stack (Nginx, API, n8n)
  # =========================================
  proxy:
    image: nginx:alpine
    container_name: n8ngame-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    depends_on:
      - frontend
      - api
      - n8n
      - supabase-kong
      - supabase-studio
    networks:
      - app_net

  certbot:
    image: certbot/certbot
    container_name: n8ngame-certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot; sleep 12h & wait $${!}; done;'"
    networks:
      - app_net

  frontend:
    image: nginx:alpine
    container_name: n8ngame-frontend
    restart: unless-stopped
    volumes:
      - ../dist:/usr/share/nginx/html:ro
    networks:
      - app_net

  api:
    image: node:20-alpine
    container_name: n8ngame-api
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ../api:/app/api
      - ../package.json:/app/package.json
      - ../package-lock.json:/app/package-lock.json
    command: sh -c "npm ci --production && node api/server.js"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_URL=postgres://${POSTGRES_USER:-n8n_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-n8ngame}
      - REDIS_URL=redis://redis:6379
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://n8n.n8ngame.com/webhook/}
      - N8N_SIGNING_SECRET=${N8N_SIGNING_SECRET}
      - CORS_ORIGIN=https://n8ngame.com
      - CORS_ORIGIN=https://n8ngame.com
      - SESSION_SECRET=${SESSION_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - SUPABASE_URL=http://supabase-kong:8000
      - SUPABASE_ANON_KEY=${ANON_KEY}
    depends_on:
      - postgres
      - redis
    networks:
      - app_net

  n8n:
    image: n8nio/n8n:latest
    container_name: n8ngame-engine
    restart: unless-stopped
    environment:
      - N8N_HOST=n8n.n8ngame.com
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.n8ngame.com/
      - N8N_EDITOR_BASE_URL=https://n8n.n8ngame.com/
      - N8N_PROXY_HOPS=1
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n_password
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - postgres
    networks:
      - app_net

  postgres:
    image: postgres:16-alpine
    container_name: n8ngame-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-n8n_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-n8ngame}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    networks:
      - app_net

  redis:
    image: redis:alpine
    container_name: n8ngame-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - app_net

  backup:
    build: ./backup
    container_name: n8ngame-backup
    restart: unless-stopped
    environment:
      - PGHOST=postgres
      - PGUSER=${POSTGRES_USER:-n8n_user}
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - S3_BUCKET=${S3_BUCKET}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=auto
      - AWS_ENDPOINT_URL=${AWS_ENDPOINT_URL}
      - TZ=Asia/Seoul
    volumes:
      - postgres_data:/backup/pg-data:ro
      - n8n_data:/backup/n8n-data:ro
      # Add Supabase DB backup in the future
    depends_on:
      - postgres
    networks:
      - app_net

  # =========================================
  # 2. Supabase Stack (Self-Hosted)
  # =========================================

  supabase-db:
    image: supabase/postgres:15.1.0.87
    container_name: supabase-db
    restart: unless-stopped
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Reuse or new var
      POSTGRES_DB: postgres
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
      # Initialize Schema on first run
      - ./supabase/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - app_net

  supabase-studio:
    image: supabase/studio:20240101-8386f66
    container_name: supabase-studio
    restart: unless-stopped
    environment:
      STUDIO_PG_META_URL: http://supabase-meta:8080
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SUPABASE_URL: https://auth.n8ngame.com
      SUPABASE_PUBLIC_URL: https://auth.n8ngame.com
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SERVICE_ROLE_KEY}
    networks:
      - app_net

  supabase-kong:
    image: kong:2.8.1
    container_name: supabase-kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      # Mapped via volume or use default template with env substitution?
      # For simplicity, we assume standard kong.yml is mapped or we use a custom one.
      # Acknowledging Supabase needs `kong.yml`. We will map a default one or create it.
      # For Phase 10-A/B, we can use the official supabase/kong image if it has pre-config, 
      # but usually it needs the file.
      # Let's map a generic one or use `supa-kong` wrapper if available.
      # Start with standard kong and minimal config needed for Supabase.
      # Better: Use `supabase/gotrue`, `supabase/postgrest` directly via Nginx? 
      # Plan says "supabase-kong" as Gateway. 
    volumes:
      - ./supabase/volumes/api/kong.yml:/var/lib/kong/kong.yml:ro
    networks:
      - app_net

  supabase-auth:
    image: supabase/gotrue:v2.132.3
    container_name: supabase-auth
    restart: unless-stopped
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
      GOTRUE_SITE_URL: https://n8ngame.com
      GOTRUE_JWT_SECRET: ${JWT_SECRET}
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
    networks:
      - app_net

  supabase-rest:
    image: postgrest/postgrest:v12.0.1
    container_name: supabase-rest
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
      PGRST_DB_SCHEMAS: public,storage,graphql_public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUC: "false"
    networks:
      - app_net

  supabase-realtime:
    image: supabase/realtime:v2.25.22
    container_name: supabase-realtime
    restart: unless-stopped
    environment:
      PORT: 4000
      DB_HOST: supabase-db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: postgres
      DB_SSL: "false"
      JWT_SECRET: ${JWT_SECRET}
      REPLICATION_MODE: RLS
    networks:
      - app_net

  supabase-storage:
    image: supabase/storage-api:v0.43.11
    container_name: supabase-storage
    restart: unless-stopped
    environment:
      ANON_KEY: ${ANON_KEY}
      SERVICE_KEY: ${SERVICE_ROLE_KEY}
      POSTGREST_URL: http://supabase-rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
    networks:
      - app_net

  supabase-meta:
    image: supabase/postgres-meta:v0.76.0
    container_name: supabase-meta
    restart: unless-stopped
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: supabase-db
      PG_META_DB_PASSWORD: ${POSTGRES_PASSWORD}
    networks:
      - app_net

networks:
  app_net:
    driver: bridge

volumes:
  # n8n Game
  postgres_data:
  n8n_data:
  redis_data:
  letsencrypt:
  certbot_webroot: # Supabase

  supabase_db_data:
